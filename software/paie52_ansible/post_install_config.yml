---
- name: Configure the required max processors and open files limits
  lineinfile:
      path: /etc/security/limits.conf
      line: "{{ item }}"
      insertbefore: '^# End of file'
  with_items:
      - "root   soft    nproc     65536"
      - "root   hard    nproc     65536"
      - "root   soft    nofile    65536"
      - "root   hard    nofile    65536"
      - "{{ ansible_user }}   soft    nproc     65536"
      - "{{ ansible_user }}   hard    nproc     65536"
      - "{{ ansible_user }}   soft    nofile    65536"
      - "{{ ansible_user }}   hard    nofile    65536"
  become: yes

- name: Set the vm_max_map_count kernel value dynamically
  command: sysctl -w vm.max_map_count=262144
  become: yes

- name: Set the vm_max_map_count kernel value in /etc/sysctl.conf
  lineinfile:
      path: /etc/sysctl.conf
      line: vm.max_map_count=262144
  become: yes

- name: Enable Performance Governor
  command: cpupower -c all frequency-set -g performance
  become: yes

- name: Enable GPU persistence mode
  command: "{{ item }}"
  with_items:
    - systemctl enable nvidia-persistenced
    - systemctl start nvidia-persistenced
  become: yes

- name: Set GPU memory and graphics clocks to their maximums
  command: "{{ item }}"
  with_items:
    - nvidia-smi -ac 715,1480
    - nvidia-smi -ac 877,1530
  become: yes

- name: Set SMT-2
  command: ppc64_cpu --smt=2
  become: yes
